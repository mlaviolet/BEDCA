---
title: "Chapter 4, Part 1: Fitting Lines, Curves, and Surfaces"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Chapter 4, Part 1: Fitting Lines, Curves, and Surfaces}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center"
  )
```

```{r setup, message=FALSE}
library(BEDCA)
library(mosaic)
library(tidyverse)
library(emmeans)
library(broom)
theme_set(theme_bw())
```

## 4.1: Fitting a Line by Least Squares

In Example 1 (p. 124) a group of students studied the effects of varying pressing pressures on the density of cylindrical specimens made by dry pressing a ceramic compound. Part of their data appears on Table 4.1 and data set `table4_01`. We've changed the units of pressure from psi to thousands of psi. First, make a scatterplot.

```{r}
ggformula::gf_point(density ~ pressure, data = table4_01,
                    xlab = "Pressure (psi x 1000)",
                    ylab = "Density (g/cc)") |> 
  ggformula::gf_lm(se = FALSE)
```

The `gf_lm()` operator adds the best fit line. Since that looks like a good fit, we'll proceed to fit the model

$$y \approx \beta_0 + \beta_1 x $$

that is, a straight line with slope $\beta_1$ and *y*-intercept $\beta_0$.

The response variable is `density`. We began our discussion of models with the null model. Now we'll fit a model adding a term for the single predictor `pressure`.

```{r}
lm_density <- lm(density ~ 1 + pressure, data = table4_01)
```

We can get a brief summary of the fit using the `msummary()` operator from the `mosaic` package. The operator `summary()` will produce a more extensive summary that we don't need yet.

```{r}
mosaic::msummary(lm_density)
```

The model is fit applying the least squares principle; the coefficients are computed to minimize the residual sum of squares. The column `Estimate` gives the coefficients: the intercept and slope of the best fit line. In this case, the fitted model is

$$\texttt{density = 2.375 + 0.0487pressure}$$

We'll discuss the details of computation shortly. The slope is interpreted as the change in the response variable for an increase in the predictor variable of one unit. Here, for each increase of 1,000 (g/cc)/psi the density increases by 0.0487 g/cc. The intercept, the point at which the line crosses the *y*-axis, only makes practical sense if a pressure of 0 psi is meaningful. In almost all cases we focus attention on the slope.

As before, we can obtain fitted values and residuals with the `augment()` function from the `broom` package.

```{r}
lm_density_aug <- augment(lm_density)
lm_density_aug
```

One purpose of fitting a model is to make predictions. If, for example, we want to predict the density of a cylinder pressed with 5,000 psi, we only need to substitute the desired pressure in the modeled linear equation.

$$\texttt{density = 2.37 + 0.0487} \times \texttt{5 = 2.619 g/cc}$$

The column `.fitted` in the augmented data gives predictions for *x* values in the original data. To make predictions for other *x* values, we construct a new data set and apply the model.

```{r}
pressure_new <- data.frame(pressure = c(5, 7.5))
pressure_new
broom::augment(lm_density, newdata = pressure_new)
```

Note that both the new predictor values are within the range of the data. Be extremely cautious if extrapolating outside that range.

The `data.frame()` operator creates a data set containing the desired predictor values; here, we get a data frame with one column `pressure` and two rows with the values 5 and 7.5. The column names must match those in the data used to fit the model. 

In fitting any model, we need to check whether the model is a good fit to the data. Some subjectivity is involved, but we have tools from which we can make that determination. The most useful tool is to plot the residuals from the augmented data. First we'll plot the residuals against the fitted values.

```{r}
ggformula::gf_point(.resid ~ .fitted, data = lm_density_aug) |> 
  gf_hline(yintercept = 0, 
           linetype = "dashed",
           xlab = "Fitted density",
           ylab = "Residual")
```

The residuals should be random noise, so the plot should show random scatter about zero. The `gf_hline()` operator adds a horizontal reference line as a visual aid. Now we'll do a normal Q-Q plot of the residuals. Recall that a straight line plot indicates that the data follow a normal (bell) curve. This code produces Figure 4.7 (p. 136).

```{r}
ggformula::gf_qq(~ .resid, data = lm_density_aug,
                 ylab = "Residual quantile",
                 xlab = "Standard normal quantile") +
  coord_flip()
```

As the authors note, some idiosyncracies in the residual plots warrant further investigation.

Discussion of R-square

Model, fitted

$$\hat{y} = b_0 + b_1 x $$

Model in R formula language

$$\texttt{y} \sim \texttt{1 + x}$$ R code for model

$$\texttt{lm(y}\sim\texttt{1 + x)}$$

Obtain results


Correlation coefficient

$$r = \frac{1}{n-1}\sum_{i=1}^{n}\left(\frac{x_i-\bar{x}}{s_x}\right)\left(\frac{y_i-\bar{y}}{s_y}\right)$$

```{r}
mosaic::cor(pressure ~ density, data = table4_01)
```

Facts about the correlation coefficient $r$

-   $-1 \le r\le 1$ ; $r$ equals 1 (-1) when all points fall on a line with positive (negative) slope

-   $r$ does not depend on which variable is the response and which is the predictor; that is, the correlation between $x$ and $y$ is the same as the correlation between $y$ and $x$

-   $r$ has no units

-   $r$ measures linear association specifically, not association in general

Formulas for regression coefficients

$$\hat{y}= b_0 + b_1x$$ where

$$\text{Slope: } b_1 = r\frac{s_y}{s_x}$$

$$\text{Intercept: } b_0 = \bar{y}-b_1\bar{x}$$

```{r}
tidy(lm_density)
glance(lm_density)
```

Get residuals data = original_data

```{r}
lm_density_aug <- augment(lm_density)
lm_density_aug
```

## 4.2: Fitting Curves and Surfaces by Least Squares

### 4.2.1 Curve Fitting by Least Squares

Correlation coefficient is nearly zero

```{r}
cor(strength ~ percent, data = table4_03)
```

Fitting quadratic to data in Table 4.3, p. 133 Actually multiple regression

```{r}
fly_ash_q <- lm(strength ~ 1 + percent + I(percent^2), data = table4_03)
mosaic::msummary(fly_ash_q)
```

Using orthogonal polynomials

```{r}
# x values are equally spaced, so okay
fly_ash_q2 <- lm(strength ~ 1 + poly(percent, 2), data = table4_03)
  mosaic::msummary(fly_ash_q2)
```

### 4.2.2 Surface Fitting by Least Squares

We'll begin this topic with Example 6, where a student studied the effects of positions, relative to the wing, of a canard (a forward lifting surface) and tail on the lift/drag ratio for a three-surface configuration.

```{r}
lm_add <- lm(lift_drag ~ 1 + canard + tail, data = table4_10)
mosaic::msummary(lm_add)
lm_add_aug <- augment(lm_add) |> 
  mutate(tail = factor(tail))
```

Graph for additive model

```{r}
ggformula::gf_point(.fitted ~ canard, data = lm_add_aug,
                    group = ~ tail,
                    shape = ~ tail) |>
  ggformula::gf_line(linetype = ~ tail,
                     show.legend = TRUE,
                     xlab = "Canard position",
                     ylab = "Fitted lift/drag ratio")  +
  scale_x_continuous(breaks = c(-1.2, 0, 1.2)) +
  theme(aspect.ratio = 0.62)
```

Full model with interaction term

```{r}
lm_full <- lm(lift_drag ~ 1 + canard + tail + canard:tail, data = table4_10)
mosaic::msummary(lm_full)
lm_full_aug <- augment(lm_full) |> 
  mutate(tail = factor(tail))
```

Fig 4.16, p. 157

```{r}
ggformula::gf_point(.fitted ~ canard, data = lm_full_aug,
                    group = ~ tail,
                    shape = ~ tail) |>
  ggformula::gf_line(linetype = ~ tail,
                     show.legend = TRUE,
                     xlab = "Canard position",
                     ylab = "Fitted lift/drag ratio")  +
  scale_x_continuous(breaks = c(-1.2, 0, 1.2)) +
  theme(aspect.ratio = 0.62)
```

```{r, eval=FALSE}
# Figure 4.16, ggplot version
ggplot(lm_full_aug) +
  aes(x = canard, y = .fitted, linetype = tail, group = tail, shape = tail) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = c(-1.2, 0, 1.2))
```

```{r, eval=FALSE}
# model equation 4.22, p. 158
lm_quad <- 
  lm(lift_drag ~ canard + tail + I(canard^2) + canard:tail, data = table4_10)

lm_quad2 <- 
  lm(lift_drag ~ poly(canard, 2) + tail + canard:tail, data = table4_10)
```

Residual plots

-   Normal plots of residuals

-   Plots of residuals against all x variables

-   Plots of residuals against fitted values

-   Plots of residuals against time order of observation

-   Plots of residuals against variables (like machine number or operator) not used in the fitted equation but potentially of importance

Subset of Brownlee stack loss data

```{r}
lm(stack ~ 1 + air + water + acid, data = table4_08)
```

Note shortcuts: intercept is not explicit; \* operator for interaction

<https://cran.r-project.org/web/packages/sjPlot/vignettes/plot_interactions.html>
